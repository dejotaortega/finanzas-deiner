{% extends "base.html" %}

{% block title %}Inicio 췅 Finanzas Deiner{% endblock %}

{% block content %}
<style>
  /* Tarjetas del resumen r치pido */
  .resumen-card .monto {
    font-size: 1.2rem;
    line-height: 1.3;
    word-wrap: break-word;
  }

  .resumen-card {
    height: 120px;            /* Tama침o consistente */
  }

  @media (max-width: 576px) {
    .resumen-card .monto {
      font-size: 1rem;
    }
    .resumen-card {
      height: 110px;
    }
  }

  /* Limitamos estiramiento de gr치ficos */
  .chart-container {
    position: relative;
    height: 260px;
    max-height: 260px;
  }
</style>

<div class="row g-4">

  <!-- COLUMNA IZQUIERDA -->
  <div class="col-12 col-lg-8">

    <!-- Bienvenida + accesos -->
    <div class="card mb-4">
      <div class="card-body">
        <h1 class="h4 mb-3">Bienvenido, Deiner 游녦</h1>
        <p class="text-muted mb-4">
          Aqu칤 Tienes tu panel para controlar el billete: cuentas, ingresos,
          gastos y res칰menes diarios/mensuales.
        </p>

        <div class="row g-3">

          <div class="col-6 col-md-3">
            <a href="{{ url_for('cuentas') }}" class="text-decoration-none">
              <div class="card border-0 h-100">
                <div class="card-body">
                  <div class="badge bg-primary badge-tag mb-2">Paso 1</div>
                  <h2 class="h6 mb-1">Cuentas</h2>
                  <p class="text-muted small mb-0">Configura tus cuentas</p>
                </div>
              </div>
            </a>
          </div>

          <div class="col-6 col-md-3">
            <a href="{{ url_for('transacciones') }}" class="text-decoration-none">
              <div class="card border-0 h-100">
                <div class="card-body">
                  <div class="badge bg-success badge-tag mb-2">D칤a a d칤a</div>
                  <h2 class="h6 mb-1">Transacciones</h2>
                  <p class="text-muted small mb-0">Registra movimientos</p>
                </div>
              </div>
            </a>
          </div>

          <div class="col-6 col-md-3">
            <a href="{{ url_for('resumen_diario') }}" class="text-decoration-none">
              <div class="card border-0 h-100">
                <div class="card-body">
                  <div class="badge bg-info badge-tag mb-2">Vista</div>
                  <h2 class="h6 mb-1">Res칰menes</h2>
                  <p class="text-muted small mb-0">Flujo diario/mensual</p>
                </div>
              </div>
            </a>
          </div>

          <div class="col-6 col-md-3">
            <a href="{{ url_for('historicos') }}" class="text-decoration-none">
              <div class="card border-0 h-100">
                <div class="card-body">
                  <div class="badge bg-warning badge-tag mb-2">Hist칩rico</div>
                  <h2 class="h6 mb-1">Historial</h2>
                  <p class="text-muted small mb-0">Movimientos pasados</p>
                </div>
              </div>
            </a>
          </div>

        </div>
      </div>
    </div>

    <!-- TARJETAS RESUMEN -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Resumen r치pido</h2>

        <div class="row g-3">

          <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100 resumen-card">
              <div class="card-body text-center">
                <h6 class="text-muted">Saldo Global</h6>
                <h4 class="fw-bold monto">{{ formatear_cop(total_global) }}</h4>
              </div>
            </div>
          </div>

          <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100 resumen-card">
              <div class="card-body text-center">
                <h6 class="text-muted">Ingresos Hoy</h6>
                <h4 class="fw-bold text-success monto">{{ formatear_cop(ingresos_hoy) }}</h4>
              </div>
            </div>
          </div>

          <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100 resumen-card">
              <div class="card-body text-center">
                <h6 class="text-muted">Gastos Hoy</h6>
                <h4 class="fw-bold text-danger monto">{{ formatear_cop(gastos_hoy) }}</h4>
              </div>
            </div>
          </div>

          <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100 resumen-card">
              <div class="card-body text-center">
                <h6 class="text-muted">Diferencia Hoy</h6>
                <h4 class="fw-bold monto {% if diferencia_hoy >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {{ formatear_cop(diferencia_hoy) }}
                </h4>
              </div>
            </div>
          </div>

          <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100 resumen-card">
              <div class="card-body text-center">
                <h6 class="text-muted">Ingresos Mes</h6>
                <h4 class="fw-bold text-success monto">{{ formatear_cop(ingresos_mes) }}</h4>
              </div>
            </div>
          </div>

          <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100 resumen-card">
              <div class="card-body text-center">
                <h6 class="text-muted">Gastos Mes</h6>
                <h4 class="fw-bold text-danger monto">{{ formatear_cop(gastos_mes) }}</h4>
              </div>
            </div>
          </div>

          <div class="col-6 col-md-3">
            <div class="card shadow-sm border-0 h-100 resumen-card">
              <div class="card-body text-center">
                <h6 class="text-muted">Diferencia Mes</h6>
                <h4 class="fw-bold monto {% if diferencia_mes >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {{ formatear_cop(diferencia_mes) }}
                </h4>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- GRAFICO MENSUAL -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Ingresos vs Gastos por mes</h2>
        <div class="chart-container">
          <canvas id="chartMeses"></canvas>
        </div>
      </div>
    </div>

<div class="card mb-4">
  <div class="card-body">
    <h2 class="h5 mb-3">Saldo Final - 칔ltimos 30 d칤as</h2>

    <div class="chart-container">
      <canvas id="chartSaldo30"></canvas>
    </div>
  </div>
</div>

    <!-- 칔LTIMAS TRANSACCIONES -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">칔ltimas transacciones</h2>

        {% if ultimas_transacciones %}
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Fecha</th>
              <th>Descripci칩n</th>
              <th>Tipo</th>
              <th>Cuenta</th>
              <th>Categor칤a</th>
              <th class="text-end">Valor</th>
            </tr>
          </thead>
          <tbody>
            {% for t in ultimas_transacciones %}
            <tr>
              <td>{{ t.fecha }}</td>
              <td>{{ t.descripcion }}</td>
              <td>
                <span class="badge {% if t.tipo=='gasto' %}bg-danger{% else %}bg-success{% endif %}">
                  {{ t.tipo }}
                </span>
              </td>
              <td>{{ t.cuenta }}</td>
              <td>{{ t.categoria }}</td>
              <td class="text-end">{{ formatear_cop(t.valor_mostrado) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        {% else %}
        <p class="text-muted mb-0">Todav칤a no hay transacciones.</p>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- COLUMNA DERECHA -->
    <div class="col-12 col-lg-4">

    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h6 mb-3">Tips de uso r치pido</h2>
        <ul class="small text-muted mb-0">
          <li>Trabaja siempre con una <strong>fecha de trabajo</strong>.</li>
          <li>Actualiza los <strong>saldos</strong> desde la pantalla de Cuentas.</li>
          <li>Cada transacci칩n ajusta el <strong>saldo global</strong>.</li>
        </ul>
      </div>
    </div>

    <!-- SALDOS POR CUENTA -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h6 mb-3">Saldos por cuenta</h2>
        {% if cuentas_dashboard %}
        <table class="table table-sm mb-0">
          <tbody>
            {% for c in cuentas_dashboard %}
            <tr>
              <td class="small">{{ c.nombre }}</td>
              <td class="text-end fw-semibold small">
                {{ formatear_cop(c.saldo) }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-muted mb-0">A칰n no has creado cuentas.</p>
        {% endif %}
      </div>
    </div>

    <!-- GASTOS POR CATEGOR칈A -->
    <div class="card mb-4">
      <div class="card-body">
        <h2 class="h6 mb-3">Gastos por categor칤a (mes actual)</h2>

        {% if cat_labels_json and cat_values_json %}
        <div class="chart-container">
          <canvas id="chartCategorias"></canvas>
        </div>
        {% else %}
        <p class="text-muted mb-0">A칰n no hay gastos este mes.</p>
        {% endif %}
      </div>
    </div>

  </div>

</div>

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const labelsMeses = {{ meses_labels_json|safe }};
  const ingresosMesData = {{ ingresos_mes_chart_json|safe }};
  const gastosMesData = {{ gastos_mes_chart_json|safe }};

  const catLabels = {{ cat_labels_json|safe }};
  const catValues = {{ cat_values_json|safe }};

  if (labelsMeses.length) {
    new Chart(document.getElementById('chartMeses'), {
      type: 'bar',
      data: {
        labels: labelsMeses,
        datasets: [
          { label: 'Ingresos', data: ingresosMesData, backgroundColor: '#4CAF50' },
          { label: 'Gastos', data: gastosMesData, backgroundColor: '#E74C3C' }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  if (catLabels.length) {
    new Chart(document.getElementById('chartCategorias'), {
      type: 'doughnut',
      data: {
        labels: catLabels,
        datasets: [
          { data: catValues }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

const fechasLinea = {{ fechas_linea_json | safe }};
  const valoresLinea = {{ valores_linea_json | safe }};

  const ctxSaldo = document.getElementById("chartSaldo30").getContext("2d");

  new Chart(ctxSaldo, {
    type: "line",
    data: {
      labels: fechasLinea,
      datasets: [{
        label: "Saldo final",
        data: valoresLinea,
        borderWidth: 2,
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: false }
      }
    }
  });
</script>

{% endblock %}
